name: Update fmapp
on:
  schedule:
    - cron: "55 22 * * *"
  workflow_dispatch: # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Repo's fmapp branch
        uses: actions/checkout@v4
        with:
          ref: cable

      - name: Download JSON and Process
        run: |
          # 1. 下载文件
          curl -s https://raw.githubusercontent.com/lystv/fmapp/app/yysd.json -o yysd.json
          
          # 2. 替换原有域名
          sed -i 's/mirror.ghproxy.com/g.blfrp.cn/g' yysd.json

          # 3. 关键修改：移除文件末尾的 ']'
          # 使用 -z 选项让 sed 跨行匹配，regex ']\s*$' 会匹配最后的 ] 以及它之后所有的空白/换行
          # 将其替换为一个空格，为追加内容做准备
          sed -i -z 's/]\s*$/ /' yysd.json

          # 4. 追加新内容（注意开头有个逗号）
          cat <<EOF >> yysd.json
          ,
               {
                  "name": "酷9",
                  "list": [
                      {
                          "name": "酷9",
                          "url": "https://g.blfrp.cn/https://raw.githubusercontent.com/danteswx/mytv/39bde9c18a6d50685534f6fbb13903014df51223/Ku9-20260217.apk",
                          "icon": "https://g.blfrp.cn/https://github.com/danteswx/mytv/blob/cable/ku9.png?raw=true",
                          "version": "ku9-1.7.7.6-2_20260217-1142"
                      }
                  ]
              }
          ]
          EOF

      - name: Commit and Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add yysd.json
          git commit -m "Update yysd.json with Ku9" || echo "No changes to commit"
          git push origin cable
